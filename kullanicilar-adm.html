<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kullanıcılar & İstatistikler | Admin</title>
  <link rel="icon" type="image/png" href="image.png" />
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Grafikler için Chart.js -->
</head>
<body>
  <h1>📊 Kullanıcılar & İstatistikler (Admin)</h1>

  <!-- Grafikler için Kapsayıcı -->
  <div id="charts-container">
    <canvas id="userGrowthChart"></canvas>
    <canvas id="songsStatsChart"></canvas>
  </div>

  <!-- Kullanıcı Listesi -->
  <h2>Siteye Kayıtlı Kullanıcılar</h2>
  <table id="user-list">
    <thead>
      <tr>
        <th>Kullanıcı Adı</th>
        <th>İsim Soyisim</th>
        <th>UID</th>
      </tr>
    </thead>
    <tbody>
      <!-- Kullanıcılar buraya yüklenecek -->
    </tbody>
  </table>

  <!-- İstatistikler -->
  <div id="stats-container">
    <div class="stat-item">
      <h3>Toplam Şarkı Sözü Sayısı</h3>
      <p id="lyricsCount">0</p>
    </div>
    <div class="stat-item">
      <h3>Toplam Melodi Sayısı</h3>
      <p id="melodyCount">0</p>
    </div>
    <div class="stat-item">
      <h3>Toplam Hazır Şarkı Sayısı</h3>
      <p id="songCount">0</p>
    </div>
  </div>

  <a href="adminpanel.html" class="admin-back-btn">⬅️ Yönetim Paneline Dön</a>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAZCCTKPRJRpGGkboQR7IYlV1VNkH73ldg",
      authDomain: "tunetra-2579b.firebaseapp.com",
      projectId: "tunetra-2579b",
      storageBucket: "tunetra-2579b.appspot.com",
      messagingSenderId: "576238823779",
      appId: "1:576238823779:web:b1796f089427e3b6fecb56"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Kullanıcılar ve İstatistikler
    let users = [];
    let lyricsCount = 0, melodyCount = 0, songCount = 0;

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = "index.html";
      
      loadUsersAndStats();
    });

    async function loadUsersAndStats() {
      // Kullanıcılar listesi
      const usersSnapshot = await getDocs(collection(db, "users"));
      usersSnapshot.forEach(doc => {
        const data = doc.data();
        users.push({
          username: data.username,
          fullName: data.fullName,
          uid: doc.id
        });
      });

      // Kullanıcıları listele
      displayUsers(users);

      // Şarkı Sözü, Melodi ve Hazır Şarkı sayıları
      const lyricsSnapshot = await getDocs(collection(db, "lyrics"));
      lyricsCount = lyricsSnapshot.size;

      const melodySnapshot = await getDocs(collection(db, "melodies"));
      melodyCount = melodySnapshot.size;

      const songsSnapshot = await getDocs(collection(db, "songs"));
      songCount = songsSnapshot.size;

      // İstatistikleri güncelle
      updateStats();
      
      // Grafiklerin Güncellenmesi
      updateCharts();
    }

    function displayUsers(users) {
      const tbody = document.querySelector("#user-list tbody");
      tbody.innerHTML = "";
      users.forEach(user => {
        tbody.innerHTML += `
          <tr>
            <td>${user.username}</td>
            <td>${user.fullName}</td>
            <td>${user.uid}</td>
          </tr>
        `;
      });
    }

    function updateStats() {
      document.getElementById("lyricsCount").textContent = lyricsCount;
      document.getElementById("melodyCount").textContent = melodyCount;
      document.getElementById("songCount").textContent = songCount;
    }

    function updateCharts() {
      const userGrowthChart = new Chart(document.getElementById("userGrowthChart"), {
        type: "line",
        data: {
          labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul"], // Zaman dilimleri
          datasets: [{
            label: 'Kullanıcı Artışı',
            data: [20, 40, 60, 80, 100, 120, 150], // Örnek veri (firebase üzerinden dinamik olarak alınabilir)
            fill: false,
            borderColor: 'rgb(75, 192, 192)',
            tension: 0.1
          }]
        }
      });

      const songsStatsChart = new Chart(document.getElementById("songsStatsChart"), {
        type: "bar",
        data: {
          labels: ["Şarkı Sözü", "Melodi", "Hazır Şarkı"],
          datasets: [{
            label: 'Yüklenen Sayılar',
            data: [lyricsCount, melodyCount, songCount],
            backgroundColor: ['#ff5733', '#33ff57', '#3357ff'],
            borderColor: ['#c13a28', '#1f9c28', '#1e6bd3'],
            borderWidth: 1
          }]
        }
      });
    }
  </script>
</body>
</html>
